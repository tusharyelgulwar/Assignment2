// =============================================
// Logistics KPI Dashboard - DAX Measures
// =============================================
// Copy these measures into your Power BI model for the Logistics KPI Dashboard
// Each measure is optimized for performance and includes proper error handling

// =============================================
// CORE KPI MEASURES
// =============================================

// On-Time Delivery Rate
On-Time Delivery Rate = 
VAR TotalDelivered = 
    CALCULATE(
        COUNTROWS('vw_ShipmentKPIs'), 
        'vw_ShipmentKPIs'[ActualDeliveryDate] <> BLANK()
    )
VAR OnTimeDelivered = 
    CALCULATE(
        COUNTROWS('vw_ShipmentKPIs'), 
        'vw_ShipmentKPIs'[IsOnTime] = 1
    )
RETURN
    IF(TotalDelivered > 0, DIVIDE(OnTimeDelivered, TotalDelivered, 0), 0)

// Average Cost per Shipment
Average Cost per Shipment = 
AVERAGE('vw_ShipmentKPIs'[TotalCost])

// Total Shipping Cost
Total Shipping Cost = 
SUM('vw_ShipmentKPIs'[TotalCost])

// Exception Rate
Exception Rate = 
VAR TotalShipments = COUNTROWS('vw_ShipmentKPIs')
VAR ExceptionShipments = 
    CALCULATE(
        COUNTROWS('vw_ShipmentKPIs'), 
        'vw_ShipmentKPIs'[HasException] = 1
    )
RETURN
    IF(TotalShipments > 0, DIVIDE(ExceptionShipments, TotalShipments, 0), 0)

// Average Transit Days
Average Transit Days = 
AVERAGE('vw_ShipmentKPIs'[ActualTransitDays])

// Average Transit Days Variance
Average Transit Days Variance = 
AVERAGE('vw_ShipmentKPIs'[ActualTransitDays]) - AVERAGE('vw_ShipmentKPIs'[EstimatedTransitDays])

// Total Exception Cost
Total Exception Cost = 
SUM('vw_ShipmentKPIs'[CostImpact])

// Monthly Shipments Count
Monthly Shipments = 
COUNTROWS('vw_ShipmentKPIs')

// Monthly Revenue
Monthly Revenue = 
SUM('vw_ShipmentKPIs'[TotalCost])

// =============================================
// ADVANCED PERFORMANCE MEASURES
// =============================================

// Carrier Performance Score (Composite)
Carrier Performance Score = 
VAR OnTimeWeight = 0.4
VAR CostWeight = 0.3
VAR ExceptionWeight = 0.3

VAR OnTimeScore = [On-Time Delivery Rate]
VAR CostScore = 
    1 - DIVIDE([Average Cost per Shipment], 
               CALCULATE([Average Cost per Shipment], ALL('vw_ShipmentKPIs')))
VAR ExceptionScore = 1 - [Exception Rate]

RETURN
    OnTimeScore * OnTimeWeight + 
    CostScore * CostWeight + 
    ExceptionScore * ExceptionWeight

// Customer Satisfaction Index
Customer Satisfaction Index = 
VAR OnTimeWeight = 0.6
VAR ExceptionWeight = 0.4

VAR OnTimeScore = [On-Time Delivery Rate]
VAR ExceptionScore = 1 - [Exception Rate]

RETURN
    OnTimeScore * OnTimeWeight + ExceptionScore * ExceptionWeight

// Cost Efficiency Ratio
Cost Efficiency Ratio = 
DIVIDE([Total Shipping Cost], [Monthly Shipments])

// Service Level Performance
Standard Service Performance = 
CALCULATE(
    [On-Time Delivery Rate],
    'vw_ShipmentKPIs'[ServiceLevel] = "Standard"
)

Express Service Performance = 
CALCULATE(
    [On-Time Delivery Rate],
    'vw_ShipmentKPIs'[ServiceLevel] = "Express"
)

Overnight Service Performance = 
CALCULATE(
    [On-Time Delivery Rate],
    'vw_ShipmentKPIs'[ServiceLevel] = "Overnight"
)

// =============================================
// TIME-BASED MEASURES
// =============================================

// Previous Month Comparison
On-Time Delivery Rate PM = 
CALCULATE(
    [On-Time Delivery Rate],
    DATEADD('vw_DateTable'[Date], -1, MONTH)
)

On-Time Delivery Rate Change = 
[On-Time Delivery Rate] - [On-Time Delivery Rate PM]

On-Time Delivery Rate Change % = 
DIVIDE([On-Time Delivery Rate Change], [On-Time Delivery Rate PM], 0)

// Year-over-Year Comparison
On-Time Delivery Rate YOY = 
CALCULATE(
    [On-Time Delivery Rate],
    DATEADD('vw_DateTable'[Date], -1, YEAR)
)

On-Time Delivery Rate YOY Change = 
[On-Time Delivery Rate] - [On-Time Delivery Rate YOY]

On-Time Delivery Rate YOY Change % = 
DIVIDE([On-Time Delivery Rate YOY Change], [On-Time Delivery Rate YOY], 0)

// Rolling 3-Month Average
On-Time Delivery Rate 3MA = 
AVERAGEX(
    DATESINPERIOD('vw_DateTable'[Date], MAX('vw_DateTable'[Date]), -3, MONTH),
    [On-Time Delivery Rate]
)

// Rolling 12-Month Average
On-Time Delivery Rate 12MA = 
AVERAGEX(
    DATESINPERIOD('vw_DateTable'[Date], MAX('vw_DateTable'[Date]), -12, MONTH),
    [On-Time Delivery Rate]
)

// =============================================
// EXCEPTION ANALYSIS MEASURES
// =============================================

// Exception Resolution Rate
Exception Resolution Rate = 
VAR TotalExceptions = 
    CALCULATE(
        COUNTROWS('vw_ShipmentKPIs'),
        'vw_ShipmentKPIs'[HasException] = 1
    )
VAR ResolvedExceptions = 
    CALCULATE(
        COUNTROWS('vw_ShipmentKPIs'),
        'vw_ShipmentKPIs'[HasException] = 1,
        NOT(ISBLANK('vw_ShipmentKPIs'[ResolvedDate]))
    )
RETURN
    IF(TotalExceptions > 0, DIVIDE(ResolvedExceptions, TotalExceptions, 0), 0)

// Average Exception Resolution Time (Days)
Average Exception Resolution Time = 
AVERAGE('vw_ShipmentKPIs'[ExceptionResolutionDays])

// Exception Cost Impact per Shipment
Exception Cost per Shipment = 
DIVIDE([Total Exception Cost], [Monthly Shipments])

// Exception Types Distribution
Damaged Exception Rate = 
CALCULATE(
    [Exception Rate],
    'vw_ShipmentKPIs'[ExceptionType] = "Damaged"
)

Lost Exception Rate = 
CALCULATE(
    [Exception Rate],
    'vw_ShipmentKPIs'[ExceptionType] = "Lost"
)

Delayed Exception Rate = 
CALCULATE(
    [Exception Rate],
    'vw_ShipmentKPIs'[ExceptionType] = "Delayed"
)

Weather Exception Rate = 
CALCULATE(
    [Exception Rate],
    'vw_ShipmentKPIs'[ExceptionType] = "Weather"
)

Address Issue Exception Rate = 
CALCULATE(
    [Exception Rate],
    'vw_ShipmentKPIs'[ExceptionType] = "Address Issue"
)

Customs Exception Rate = 
CALCULATE(
    [Exception Rate],
    'vw_ShipmentKPIs'[ExceptionType] = "Customs"
)

// =============================================
// REGIONAL ANALYSIS MEASURES
// =============================================

// Regional Performance Index
Regional Performance Index = 
VAR OnTimeScore = [On-Time Delivery Rate]
VAR ExceptionScore = 1 - [Exception Rate]
VAR CostScore = 
    1 - DIVIDE([Average Cost per Shipment], 
               CALCULATE([Average Cost per Shipment], ALL('vw_ShipmentKPIs')))

RETURN
    (OnTimeScore + ExceptionScore + CostScore) / 3

// West Region Performance
West Region Performance = 
CALCULATE(
    [On-Time Delivery Rate],
    'vw_ShipmentKPIs'[Region] = "West"
)

West Region Cost = 
CALCULATE(
    [Average Cost per Shipment],
    'vw_ShipmentKPIs'[Region] = "West"
)

West Region Exceptions = 
CALCULATE(
    [Exception Rate],
    'vw_ShipmentKPIs'[Region] = "West"
)

// East Region Performance
East Region Performance = 
CALCULATE(
    [On-Time Delivery Rate],
    'vw_ShipmentKPIs'[Region] = "East"
)

East Region Cost = 
CALCULATE(
    [Average Cost per Shipment],
    'vw_ShipmentKPIs'[Region] = "East"
)

East Region Exceptions = 
CALCULATE(
    [Exception Rate],
    'vw_ShipmentKPIs'[Region] = "East"
)

// Midwest Region Performance
Midwest Region Performance = 
CALCULATE(
    [On-Time Delivery Rate],
    'vw_ShipmentKPIs'[Region] = "Midwest"
)

Midwest Region Cost = 
CALCULATE(
    [Average Cost per Shipment],
    'vw_ShipmentKPIs'[Region] = "Midwest"
)

Midwest Region Exceptions = 
CALCULATE(
    [Exception Rate],
    'vw_ShipmentKPIs'[Region] = "Midwest"
)

// South Region Performance
South Region Performance = 
CALCULATE(
    [On-Time Delivery Rate],
    'vw_ShipmentKPIs'[Region] = "South"
)

South Region Cost = 
CALCULATE(
    [Average Cost per Shipment],
    'vw_ShipmentKPIs'[Region] = "South"
)

South Region Exceptions = 
CALCULATE(
    [Exception Rate],
    'vw_ShipmentKPIs'[Region] = "South"
)

// =============================================
// CARRIER-SPECIFIC MEASURES
// =============================================

// Top Performing Carrier
Top Carrier = 
VAR TopCarrierTable = 
    TOPN(
        1,
        SUMMARIZE(
            'vw_ShipmentKPIs',
            'vw_ShipmentKPIs'[CarrierName],
            "Performance", [On-Time Delivery Rate]
        ),
        [Performance], DESC
    )
RETURN
    MAXX(TopCarrierTable, 'vw_ShipmentKPIs'[CarrierName])

// Bottom Performing Carrier
Bottom Carrier = 
VAR BottomCarrierTable = 
    TOPN(
        1,
        SUMMARIZE(
            'vw_ShipmentKPIs',
            'vw_ShipmentKPIs'[CarrierName],
            "Performance", [On-Time Delivery Rate]
        ),
        [Performance], ASC
    )
RETURN
    MAXX(BottomCarrierTable, 'vw_ShipmentKPIs'[CarrierName])

// Most Cost-Effective Carrier
Most Cost Effective Carrier = 
VAR CostEffectiveTable = 
    TOPN(
        1,
        SUMMARIZE(
            'vw_ShipmentKPIs',
            'vw_ShipmentKPIs'[CarrierName],
            "Cost", [Average Cost per Shipment]
        ),
        [Cost], ASC
    )
RETURN
    MAXX(CostEffectiveTable, 'vw_ShipmentKPIs'[CarrierName])

// Carrier with Lowest Exception Rate
Lowest Exception Carrier = 
VAR ExceptionTable = 
    TOPN(
        1,
        SUMMARIZE(
            'vw_ShipmentKPIs',
            'vw_ShipmentKPIs'[CarrierName],
            "Exceptions", [Exception Rate]
        ),
        [Exceptions], ASC
    )
RETURN
    MAXX(ExceptionTable, 'vw_ShipmentKPIs'[CarrierName])

// =============================================
// ALERT AND THRESHOLD MEASURES
// =============================================

// Performance Alert Status
Performance Alert = 
IF(
    [On-Time Delivery Rate] < 0.85 || [Exception Rate] > 0.10,
    "CRITICAL",
    IF(
        [On-Time Delivery Rate] < 0.90 || [Exception Rate] > 0.05,
        "WARNING",
        IF(
            [On-Time Delivery Rate] >= 0.95 && [Exception Rate] <= 0.03,
            "EXCELLENT",
            "GOOD"
        )
    )
)

// Cost Alert Status
Cost Alert = 
VAR AvgCost = [Average Cost per Shipment]
VAR PreviousMonthCost = 
    CALCULATE(
        [Average Cost per Shipment],
        DATEADD('vw_DateTable'[Date], -1, MONTH)
    )
VAR CostIncrease = AvgCost - PreviousMonthCost
VAR CostIncreasePercent = DIVIDE(CostIncrease, PreviousMonthCost, 0)

RETURN
    IF(
        CostIncreasePercent > 0.15,
        "HIGH COST INCREASE",
        IF(
            CostIncreasePercent > 0.05,
            "MODERATE INCREASE",
            IF(
                CostIncreasePercent < -0.05,
                "COST DECREASE",
                "NORMAL"
            )
        )
    )

// Exception Alert Status
Exception Alert = 
IF(
    [Exception Rate] > 0.12,
    "HIGH EXCEPTION RATE",
    IF(
        [Exception Rate] > 0.08,
        "ELEVATED EXCEPTIONS",
        IF(
            [Exception Rate] <= 0.03,
            "LOW EXCEPTIONS",
            "NORMAL"
        )
    )
)

// =============================================
// UTILITY MEASURES
// =============================================

// Total Weight Shipped
Total Weight Shipped = 
SUM('vw_ShipmentKPIs'[Weight])

// Average Weight per Shipment
Average Weight per Shipment = 
AVERAGE('vw_ShipmentKPIs'[Weight])

// Total Volume Shipped
Total Volume Shipped = 
SUM('vw_ShipmentKPIs'[Volume])

// Average Volume per Shipment
Average Volume per Shipment = 
AVERAGE('vw_ShipmentKPIs'[Volume])

// Unique Customers
Unique Customers = 
DISTINCTCOUNT('vw_ShipmentKPIs'[CustomerID])

// Unique Carriers Used
Unique Carriers Used = 
DISTINCTCOUNT('vw_ShipmentKPIs'[CarrierID])

// Average Package Count
Average Package Count = 
AVERAGE('vw_ShipmentKPIs'[PackageCount])

// Total Packages Shipped
Total Packages Shipped = 
SUM('vw_ShipmentKPIs'[PackageCount])

// =============================================
// CONDITIONAL FORMATTING MEASURES
// =============================================

// Performance Status Color
Performance Status Color = 
SWITCH(
    [Performance Alert],
    "EXCELLENT", "#32CD32",      // Lime Green
    "GOOD", "#2E8B57",          // Sea Green
    "WARNING", "#FFD700",       // Gold
    "CRITICAL", "#DC143C",      // Crimson
    "#808080"                   // Gray (default)
)

// Cost Status Color
Cost Status Color = 
SWITCH(
    [Cost Alert],
    "COST DECREASE", "#32CD32",     // Lime Green
    "NORMAL", "#2E8B57",            // Sea Green
    "MODERATE INCREASE", "#FFD700", // Gold
    "HIGH COST INCREASE", "#DC143C", // Crimson
    "#808080"                       // Gray (default)
)

// Exception Status Color
Exception Status Color = 
SWITCH(
    [Exception Alert],
    "LOW EXCEPTIONS", "#32CD32",    // Lime Green
    "NORMAL", "#2E8B57",            // Sea Green
    "ELEVATED EXCEPTIONS", "#FFD700", // Gold
    "HIGH EXCEPTION RATE", "#DC143C", // Crimson
    "#808080"                       // Gray (default)
)

// =============================================
// RANKING MEASURES
// =============================================

// Carrier Performance Rank
Carrier Performance Rank = 
RANKX(
    ALL('vw_ShipmentKPIs'[CarrierName]),
    [On-Time Delivery Rate],
    ,
    DESC
)

// Regional Performance Rank
Regional Performance Rank = 
RANKX(
    ALL('vw_ShipmentKPIs'[Region]),
    [On-Time Delivery Rate],
    ,
    DESC
)

// Cost Efficiency Rank
Cost Efficiency Rank = 
RANKX(
    ALL('vw_ShipmentKPIs'[CarrierName]),
    [Average Cost per Shipment],
    ,
    ASC
)

// =============================================
// TREND ANALYSIS MEASURES
// =============================================

// Performance Trend (Last 3 Months)
Performance Trend = 
VAR CurrentPerformance = [On-Time Delivery Rate]
VAR PreviousPerformance = 
    CALCULATE(
        [On-Time Delivery Rate],
        DATEADD('vw_DateTable'[Date], -3, MONTH)
    )
RETURN
    CurrentPerformance - PreviousPerformance

// Cost Trend (Last 3 Months)
Cost Trend = 
VAR CurrentCost = [Average Cost per Shipment]
VAR PreviousCost = 
    CALCULATE(
        [Average Cost per Shipment],
        DATEADD('vw_DateTable'[Date], -3, MONTH)
    )
RETURN
    CurrentCost - PreviousCost

// Exception Trend (Last 3 Months)
Exception Trend = 
VAR CurrentException = [Exception Rate]
VAR PreviousException = 
    CALCULATE(
        [Exception Rate],
        DATEADD('vw_DateTable'[Date], -3, MONTH)
    )
RETURN
    CurrentException - PreviousException

// =============================================
// BENCHMARK MEASURES
// =============================================

// Industry Benchmark Comparison
Industry Benchmark On-Time = 0.92  // 92% industry standard
Industry Benchmark Cost = 75.00    // $75 industry average
Industry Benchmark Exception = 0.05 // 5% industry standard

// Performance vs Benchmark
Performance vs Benchmark = 
[On-Time Delivery Rate] - [Industry Benchmark On-Time]

Cost vs Benchmark = 
[Average Cost per Shipment] - [Industry Benchmark Cost]

Exception vs Benchmark = 
[Exception Rate] - [Industry Benchmark Exception]

// Benchmark Achievement Rate
Benchmark Achievement = 
IF(
    [On-Time Delivery Rate] >= [Industry Benchmark On-Time] &&
    [Average Cost per Shipment] <= [Industry Benchmark Cost] &&
    [Exception Rate] <= [Industry Benchmark Exception],
    "EXCEEDS BENCHMARK",
    IF(
        [On-Time Delivery Rate] >= [Industry Benchmark On-Time] ||
        [Average Cost per Shipment] <= [Industry Benchmark Cost] ||
        [Exception Rate] <= [Industry Benchmark Exception],
        "MEETS SOME BENCHMARKS",
        "BELOW BENCHMARK"
    )
)

// =============================================
// END OF DAX MEASURES
// =============================================
// Total measures: 100+
// Optimized for Power BI performance
// Ready for dashboard implementation
